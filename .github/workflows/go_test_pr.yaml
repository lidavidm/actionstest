# Copyright (c) 2025 ADBC Drivers Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# !!!! AUTO-GENERATED FILE.  DO NOT EDIT. !!!!
# USE adbc-gen-workflow (see adbc-drivers/dev) TO UPDATE THIS FILE.

name: Go Test PR

on:
  workflow_dispatch:
    inputs:
      pr:
        description: "The PR to comment on"
        required: true
        type: string
      repository:
        description: "The repository to checkout"
        required: true
        type: string
      commit:
        description: "The commit to checkout"
        required: true
        type: string

concurrency:
  group: ${{ github.repository }}-${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  test:
    uses: lidavidm/actionstest/.github/workflows/go_test.yaml@main
    with:
      repository: ${{ inputs.repository }}
      commit: ${{ inputs.commit }}

  report:
    name: comment on PR
    runs-on: ubuntu-slim
    if: ${{ always() }}
    needs:
      - test
    permissions:
      pull-requests: write

    steps:
      - id: get_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo Passed: ${{ needs.test.result }}
          echo gh run --repo ${{ github.repository }} view ${{ github.run_id }} --json jobs --jq '.jobs[] | select(.name == "test") | .url'
          gh run --repo ${{ github.repository }} view ${{ github.run_id }} --json jobs --jq '.jobs[] | select(.name == "test") | .url'
          echo workflow_run_url=$(gh run --repo ${{ github.repository }} view ${{ github.run_id }} --json jobs --jq '.jobs[] | select(.name == "test") | .url') >> $GITHUB_OUTPUT

      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Go tests completed: ${{ needs.test.result }}\nWorkflow run: ${{ steps.get_run.workflow_run_url }}'
            })
